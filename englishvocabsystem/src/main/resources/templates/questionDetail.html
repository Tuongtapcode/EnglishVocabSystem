<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Exercise Question Form</title>
    <th:context th:replace="~{base :: resources}">
    </th:context>
    <style>
        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 1rem 1rem 0 0;
            padding: 1.5rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section:last-of-type {
            border-bottom: none;
            margin-bottom: 1rem;
        }

        .form-section h5 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .form-control,
        .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
            outline: none;
        }

        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25);
        }

        .option-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .option-item.correct-option {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .option-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .option-number {
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .correct-badge {
            background: #10b981;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .btn-remove-option {
            background: #ef4444;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove-option:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .btn-add-option {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-add-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .preview-section {
            background: #f8fafc;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .readonly-field {
            background-color: #f8f9fa;
            opacity: 0.8;
        }

        .question-format-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .no-options-message {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 2rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            border: 2px dashed #d1d5db;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div th:replace="~{base :: sidebar}"></div>
    
    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div th:replace="~{base :: top-bar}"></div>

        <div class="content-area">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow">
                        <div class="card-header text-center">
                            <h3 class="mb-0">
                                <i class="fas fa-question-circle me-2"></i>
                                Quản lý câu hỏi bài tập
                            </h3>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/admin/exercise-questions}" method="post" 
                                  enctype="multipart/form-data" th:object="${exerciseQuestion}">
                                
                                <input type="hidden" th:field="*{id}" />
                                
                                <!-- Thông tin cơ bản -->
                                <div class="form-section">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Thông tin cơ bản
                                    </h5>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="exercise" class="form-label">Bài tập<span class="text-danger">*</span></label>
                                                <select th:field="*{exercise.id}" class="form-select" id="exercise" required>
                                                    <option value="">Chọn bài tập...</option>
                                                    <option th:each="ex : ${exercises}" 
                                                            th:value="${ex.id}" 
                                                            th:text="${ex.title}"></option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="word" class="form-label">Từ vựng<span class="text-danger">*</span></label>
                                                <select th:field="*{word.id}" class="form-select" id="word" required>
                                                    <option value="">Chọn từ vựng...</option>
                                                    <option th:each="w : ${words}" 
                                                            th:value="${w.id}" 
                                                            th:text="${w.englishWord + ' - ' + w.vietnameseMeaning}"></option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="questionText" class="form-label">Nội dung câu hỏi<span class="text-danger">*</span></label>
                                        <textarea th:field="*{questionText}" class="form-control" 
                                                  id="questionText" rows="4" required
                                                  placeholder="Nhập nội dung câu hỏi..."></textarea>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="questionFormat" class="form-label">Định dạng câu hỏi<span class="text-danger">*</span></label>
                                                <select th:field="*{questionFormat}" class="form-select" id="questionFormat" required>
                                                    <option value="">Chọn định dạng...</option>
                                                    <option value="MULTIPLE_CHOICE">Trắc nghiệm (Multiple Choice)</option>
                                                    <option value="TRUE_FALSE">Đúng/Sai (True/False)</option>
                                                    <option value="FILL_BLANK">Điền vào chỗ trống (Fill in the Blank)</option>
                                                    <option value="MATCHING">Ghép đôi (Matching)</option>
                                                </select>
                                                <div class="question-format-info" id="formatInfo" style="display: none;">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <span id="formatDescription"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="difficultyScore" class="form-label">Điểm độ khó</label>
                                                <input th:field="*{difficultyScore}" type="number" 
                                                       class="form-control" id="difficultyScore" 
                                                       min="0.1" max="5.0" step="0.1" 
                                                       placeholder="1.0">
                                                <small class="text-muted">Từ 0.1 (dễ) đến 5.0 (khó)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Media -->
                                <div class="form-section">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-photo-video me-2"></i>
                                        Media hỗ trợ
                                    </h5>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="imageUrl" class="form-label">URL hình ảnh</label>
                                                <input th:field="*{imageUrl}" type="url" class="form-control"
                                                       id="imageUrl" placeholder="https://example.com/image.jpg">
                                            </div>

                                            <div class="preview-section mt-2" th:if="${exerciseQuestion.imageUrl != null}">
                                                <img th:src="${exerciseQuestion.imageUrl}" alt="Ảnh câu hỏi"
                                                     class="img-fluid rounded" style="max-height: 200px;">
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="audioUrl" class="form-label">URL âm thanh</label>
                                                <input th:field="*{audioUrl}" type="url" class="form-control"
                                                       id="audioUrl" placeholder="https://example.com/audio.mp3">
                                            </div>

                                            <div class="preview-section mt-2" th:if="${exerciseQuestion.audioUrl != null}">
                                                <audio controls class="w-100" style="max-width: 300px;">
                                                    <source th:src="${exerciseQuestion.audioUrl}" type="audio/mpeg">
                                                    Trình duyệt không hỗ trợ audio.
                                                </audio>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Giải thích -->
                                <div class="form-section">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-lightbulb me-2"></i>
                                        Giải thích
                                    </h5>

                                    <div class="mb-3">
                                        <label for="explanation" class="form-label">Giải thích đáp án</label>
                                        <textarea th:field="*{explanation}" class="form-control" 
                                                  id="explanation" rows="3"
                                                  placeholder="Nhập giải thích cho đáp án đúng..."></textarea>
                                    </div>
                                </div>

                                <!-- Các đáp án -->
                                <div class="form-section">
                                    <h5 class="text-primary mb-3">
                                        <i class="fas fa-list-ul me-2"></i>
                                        Các đáp án
                                    </h5>

                                    <div id="optionsContainer">
                                        <!-- Hiển thị các options hiện có -->
                                        <div class="no-options-message" id="noOptionsMessage" 
                                             th:if="${exerciseQuestion.options == null || exerciseQuestion.options.isEmpty()}">
                                            <i class="fas fa-plus-circle fa-2x mb-2"></i>
                                            <p class="mb-0">Chưa có đáp án nào. Nhấn "Thêm đáp án" để tạo đáp án đầu tiên.</p>
                                        </div>

                                        <!-- Hiển thị options hiện có (nếu có) -->
                                        <div th:each="option, iterStat : ${exerciseQuestion.options}" 
                                             class="option-item" th:classappend="${option.isCorrect} ? 'correct-option' : ''">
                                            
                                            <input type="hidden" th:name="|options[${iterStat.index}].id|" th:value="${option.id}">
                                            
                                            <div class="option-header">
                                                <div class="d-flex align-items-center">
                                                    <div class="option-number" th:text="${iterStat.index + 1}"></div>
                                                    <span class="correct-badge ms-2" th:if="${option.isCorrect}">
                                                        <i class="fas fa-check me-1"></i>Đáp án đúng
                                                    </span>
                                                </div>
                                                <button type="button" class="btn-remove-option" onclick="removeOption(this)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-9">
                                                    <div class="mb-3">
                                                        <label class="form-label">Nội dung đáp án</label>
                                                        <input type="text" th:name="|options[${iterStat.index}].optionText|" 
                                                               th:value="${option.optionText}"
                                                               class="form-control" required
                                                               placeholder="Nhập nội dung đáp án...">
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label class="form-label">Đáp án đúng?</label>
                                                        <div class="form-check form-switch">
                                                            <input type="hidden" th:name="|options[${iterStat.index}].isCorrect|" value="false">
                                                            <input type="checkbox" th:name="|options[${iterStat.index}].isCorrect|" 
                                                                   th:checked="${option.isCorrect}"
                                                                   class="form-check-input" 
                                                                   onchange="toggleCorrectOption(this)">
                                                            <label class="form-check-label">
                                                                Đúng
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="text-center mt-3">
                                        <button type="button" class="btn-add-option" onclick="addOption()">
                                            <i class="fas fa-plus me-2"></i>
                                            Thêm đáp án
                                        </button>
                                    </div>
                                </div>

                                <!-- Nút hành động -->
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary btn-lg me-2">
                                        <span th:if="${exerciseQuestion.id == null}">
                                            <i class="fas fa-plus me-2"></i>
                                            Tạo câu hỏi
                                        </span>
                                        <span th:if="${exerciseQuestion.id != null}">
                                            <i class="fas fa-save me-2"></i>
                                            Cập nhật câu hỏi
                                        </span>
                                    </button>

                                    <button type="button" class="btn btn-outline-info btn-lg me-2"
                                            onclick="previewQuestion()">
                                        <i class="fas fa-eye me-2"></i>
                                        Xem trước
                                    </button>

                                    <a href="/admin/exercise-questions" class="btn btn-outline-secondary btn-lg me-2">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Quay lại
                                    </a>

                                    <button type="reset" class="btn btn-outline-danger btn-lg">
                                        <i class="fas fa-undo me-2"></i>
                                        Đặt lại
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/main.js}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let optionIndex = 0;
        
        // Initialize option index based on existing options
        document.addEventListener('DOMContentLoaded', function() {
            const existingOptions = document.querySelectorAll('.option-item');
            optionIndex = existingOptions.length;
            
            // Update option numbers
            updateOptionNumbers();
        });

        // Question format descriptions
        const formatDescriptions = {
            'MULTIPLE_CHOICE': 'Câu hỏi trắc nghiệm với nhiều lựa chọn, chỉ có một đáp án đúng.',
            'TRUE_FALSE': 'Câu hỏi đúng/sai với hai lựa chọn: Đúng hoặc Sai.',
            'FILL_BLANK': 'Câu hỏi điền vào chỗ trống, học sinh nhập đáp án.',
            'MATCHING': 'Câu hỏi ghép đôi, học sinh nối các cặp tương ứng.'
        };

        // Show format description
        document.getElementById('questionFormat').addEventListener('change', function() {
            const formatInfo = document.getElementById('formatInfo');
            const formatDescription = document.getElementById('formatDescription');
            
            if (this.value && formatDescriptions[this.value]) {
                formatDescription.textContent = formatDescriptions[this.value];
                formatInfo.style.display = 'block';
            } else {
                formatInfo.style.display = 'none';
            }
        });

        function addOption() {
            const container = document.getElementById('optionsContainer');
            const noOptionsMessage = document.getElementById('noOptionsMessage');
            
            // Hide no options message
            if (noOptionsMessage) {
                noOptionsMessage.style.display = 'none';
            }

            const optionHtml = `
                <div class="option-item">
                    <input type="hidden" name="options[${optionIndex}].id" value="">
                    
                    <div class="option-header">
                        <div class="d-flex align-items-center">
                            <div class="option-number">${optionIndex + 1}</div>
                        </div>
                        <button type="button" class="btn-remove-option" onclick="removeOption(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-9">
                            <div class="mb-3">
                                <label class="form-label">Nội dung đáp án</label>
                                <input type="text" name="options[${optionIndex}].optionText" 
                                       class="form-control" required
                                       placeholder="Nhập nội dung đáp án...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Đáp án đúng?</label>
                                <div class="form-check form-switch">
                                    <input type="hidden" name="options[${optionIndex}].isCorrect" value="false">
                                    <input type="checkbox" name="options[${optionIndex}].isCorrect" 
                                           class="form-check-input" 
                                           onchange="toggleCorrectOption(this)">
                                    <label class="form-check-label">
                                        Đúng
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', optionHtml);
            optionIndex++;
        }

        function removeOption(button) {
            const optionItem = button.closest('.option-item');
            optionItem.remove();
            
            // Update option numbers and indices
            updateOptionNumbers();
            
            // Show no options message if no options left
            const remainingOptions = document.querySelectorAll('.option-item');
            const noOptionsMessage = document.getElementById('noOptionsMessage');
            if (remainingOptions.length === 0 && noOptionsMessage) {
                noOptionsMessage.style.display = 'block';
            }
        }

        function updateOptionNumbers() {
            const options = document.querySelectorAll('.option-item');
            options.forEach((option, index) => {
                // Update option number display
                const numberDisplay = option.querySelector('.option-number');
                if (numberDisplay) {
                    numberDisplay.textContent = index + 1;
                }
                
                // Update form field names
                const inputs = option.querySelectorAll('input[name^="options["]');
                inputs.forEach(input => {
                    const currentName = input.name;
                    const newName = currentName.replace(/options\[\d+\]/, `options[${index}]`);
                    input.name = newName;
                });
            });
            
            // Update global option index
            optionIndex = options.length;
        }

        function toggleCorrectOption(checkbox) {
            const optionItem = checkbox.closest('.option-item');
            const correctBadge = optionItem.querySelector('.correct-badge');
            
            if (checkbox.checked) {
                optionItem.classList.add('correct-option');
                if (!correctBadge) {
                    const badge = document.createElement('span');
                    badge.className = 'correct-badge ms-2';
                    badge.innerHTML = '<i class="fas fa-check me-1"></i>Đáp án đúng';
                    optionItem.querySelector('.d-flex.align-items-center').appendChild(badge);
                }
            } else {
                optionItem.classList.remove('correct-option');
                if (correctBadge) {
                    correctBadge.remove();
                }
            }
        }

        function previewQuestion() {
            const questionText = document.getElementById('questionText').value;
            const explanation = document.getElementById('explanation').value;
            const options = document.querySelectorAll('.option-item');
            
            if (!questionText.trim()) {
                alert('Vui lòng nhập nội dung câu hỏi trước khi xem trước!');
                return;
            }

            let previewHtml = `
                <div class="modal fade" id="previewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Xem trước câu hỏi</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <strong>Câu hỏi:</strong>
                                    <p class="mt-2">${questionText}</p>
                                </div>
            `;

            if (options.length > 0) {
                previewHtml += '<div class="mb-3"><strong>Các đáp án:</strong><ul class="mt-2">';
                options.forEach((option, index) => {
                    const text = option.querySelector('input[type="text"]').value;
                    const isCorrect = option.querySelector('input[type="checkbox"]').checked;
                    previewHtml += `<li>${text} ${isCorrect ? '<span class="badge bg-success">Đúng</span>' : ''}</li>`;
                });
                previewHtml += '</ul></div>';
            }

            if (explanation.trim()) {
                previewHtml += `
                    <div class="mb-3">
                        <strong>Giải thích:</strong>
                        <p class="mt-2">${explanation}</p>
                    </div>
                `;
            }

            previewHtml += `
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('previewModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', previewHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }
    </script>

</body>
</html>